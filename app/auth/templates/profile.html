{% extends "common/templates/_layouts/base.html" %}

{% block title %}Profile - {{ user.display_name }}{% endblock %}

{% block content %}
<div class="max-w-2xl mx-auto w-full space-y-2">
    <!-- User Profile Header -->
    <div class="bg-white rounded-xl p-4 md:p-6">
        <div class="flex items-start justify-between">
            <div class="space-y-4">
                <div>
                    <!-- Display Name View/Edit -->
                    <div class="flex items-center gap-2">
                        <h1 id="displayNameView" class="text-2xl font-bold text-stone-900">{{ user.display_name }}</h1>
                        <button onclick="toggleDisplayNameEdit()" class="text-stone-400 hover:text-stone-600" title="Edit display name">
                            <svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" />
                            </svg>
                        </button>
                        <form id="displayNameForm" action="{{ url_for('auth.update_display_name') }}" method="POST" class="hidden flex-1 items-center gap-2">
                            <input type="text" name="display_name" value="{{ user.display_name }}" class="form-input" required placeholder="Enter your display name">
                            <button type="submit" class="btn-primary btn-circle-sm">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-4">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="m4.5 12.75 6 6 9-13.5" />
                                </svg>
                            </button>
                            <button type="button" onclick="toggleDisplayNameEdit()" class="btn-secondary btn-circle-sm">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-4">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M6 18 18 6M6 6l12 12" />
                                </svg>
                            </button>
                        </form>
                    </div>
                </div>
                <div class="space-y-1">
                    <div class="flex items-center gap-2">
                        <p class="text-stone-500">{{ user.email }} {% if pending_email %} ({{ pending_email }} : pending) {% endif %}</p>
                        <a href="{{ url_for('auth.change_email') }}" class="text-yellow-600 hover:text-yellow-700 text-sm">
                            Change
                        </a>
                    </div>
                    <p class="text-sm text-stone-400">
                        Member since
                        <span
                            data-timestamp="{{ user.registered_at.isoformat() }}"
                            data-timestamp-format="MMMM DD, YYYY"
                        >
                            {{ user.registered_at.strftime('%B %d, %Y') }}
                        </span>
                    </p>
                </div>
            </div>
            <a href="{{ url_for('auth.logout') }}" class="btn-alert">
                Sign Out
            </a>
        </div>
    </div>

    <!-- Connected Providers -->
    <a name="connected-accounts"></a>
    <div class="bg-white rounded-xl p-4 md:p-6">
        <div class="border-b border-stone-200 pb-4 mb-4">
            <h2 class="text-lg font-semibold text-stone-900">Connected Providers</h2>
            <p class="text-sm text-stone-500">Manage your connected authentication providers</p>
        </div>

        <div class="space-y-6">
            <!-- Connected Providers List -->
            {% if user.providers %}
                <div class="space-y-4">
                    {% for provider in user.providers %}
                        <div class="flex items-center justify-between p-4 bg-stone-50 rounded-lg">
                            <div class="space-y-1">
                                <div class="flex items-center gap-2">
                                    <span class="font-medium text-stone-900">{{ provider.name.title() }}</span>
                                    {% if provider.is_verified %}
                                        <span class="inline-flex items-center rounded-md bg-green-50 px-2 py-1 text-xs font-medium text-green-700 ring-1 ring-inset ring-green-600/20">
                                            Verified
                                        </span>
                                    {% else %}
                                        <div class="flex items-center gap-2">
                                            <span class="inline-flex items-center rounded-md bg-yellow-50 px-2 py-1 text-xs font-medium text-yellow-700 ring-1 ring-inset ring-yellow-600/20">
                                                Pending
                                            </span>
                                            <form action="{{ url_for('auth.send_verify_email.post') }}" method="POST" class="inline">
                                                <input type="hidden" name="email" value="{{ provider.email }}">
                                                <input type="hidden" name="provider_name" value="{{ provider.name }}">
                                                <button type="submit" class="text-xs text-yellow-600 hover:text-yellow-700">
                                                    Resend verification
                                                </button>
                                            </form>
                                        </div>
                                    {% endif %}
                                </div>
                                <p class="text-sm text-stone-500">{{ provider.email }}</p>
                                <p class="text-xs text-stone-400">
                                    Connected on
                                    <span
                                        data-timestamp="{{ provider.added_at.isoformat() }}"
                                        data-timestamp-format="MMMM DD, YYYY"
                                    >
                                        {{ provider.added_at.strftime('%B %d, %Y') }}
                                    </span>
                                </p>
                            </div>
                            {% if user.providers|length > 1 %}
                            <form action="{{ url_for('auth.disconnect_provider', provider=provider.name) }}" method="POST" class="inline" onsubmit="return confirm('Are you sure disconnect this account?')">
                                <button type="submit" class="btn-alert btn-sm">
                                    Disconnect
                                </button>
                            </form>
                            {% endif %}
                        </div>
                    {% endfor %}
                </div>
            {% endif %}

            <!-- Available Providers -->
            <div class="border-t border-stone-200 pt-6">
                <h3 class="text-base font-semibold text-stone-900">Connect Additional Providers</h3>
                <p class="mt-1 text-sm text-stone-500">Link your account with these authentication providers</p>
                <div class="mt-4 grid grid-cols-1 gap-4 sm:grid-cols-2">
                    {% set connected_providers = user.providers | map(attribute='name') | list %}

                    {% if 'local' not in connected_providers %}
                    <a href="{{ url_for('auth.connect_local') }}" class="relative flex items-center space-x-3 rounded-lg border border-stone-300 bg-white px-6 py-5 shadow-sm hover:border-stone-400">
                        <div class="flex-shrink-0">
                            <svg class="size-6 text-stone-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                            </svg>
                        </div>
                        <div class="min-w-0 flex-1">
                            <span class="absolute inset-0" aria-hidden="true"></span>
                            <p class="text-sm font-medium text-stone-900">Connect Local Account</p>
                            <p class="text-sm text-stone-500">Link an email/password login</p>
                        </div>
                    </a>
                    {% endif %}

                    {% for provider_name in list_of_sso_providers.keys() %}
                        {% if provider_name not in connected_providers and provider_name != 'local' %}
                        <a href="{{ url_for('auth.providers.connect', provider=provider_name) }}" class="relative flex items-center space-x-3 rounded-lg border border-stone-300 bg-white px-6 py-5 shadow-sm hover:border-stone-400">
                            <div class="flex-shrink-0">
                                {% if provider_name == 'github' %}
                                <svg class="size-6 text-stone-600" fill="currentColor" role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M12 .297c-6.63 0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577 0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93 0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176 0 0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22 0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22 0 1.606-.015 2.896-.015 3.286 0 .315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12"/>
                                </svg>
                                {% elif provider_name == 'google' %}
                                <svg class="size-6 text-stone-600" fill="currentColor" role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M12.48 10.92v3.28h7.84c-.24 1.84-.853 3.187-1.787 4.133-1.147 1.147-2.933 2.4-6.053 2.4-4.827 0-8.6-3.893-8.6-8.72s3.773-8.72 8.6-8.72c2.6 0 4.507 1.027 5.907 2.347l2.307-2.307C18.747 1.44 16.133 0 12.48 0 5.867 0 .307 5.387.307 12s5.56 12 12.173 12c3.573 0 6.267-1.173 8.373-3.36 2.16-2.16 2.84-5.213 2.84-7.667 0-.76-.053-1.467-.173-2.053H12.48z"/>
                                </svg>
                                {% else %}
                                <svg class="size-6 text-stone-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1" />
                                </svg>
                                {% endif %}
                            </div>
                            <div class="min-w-0 flex-1">
                                <span class="absolute inset-0" aria-hidden="true"></span>
                                <p class="text-sm font-medium text-stone-900">Connect {{ provider_name | title }}</p>
                                <p class="text-sm text-stone-500">Link your {{ provider_name | title }} account</p>
                            </div>
                        </a>
                        {% endif %}
                    {% endfor %}

                    {% if not user.providers %}
                    <div class="relative flex items-center space-x-3 rounded-lg border border-stone-300 bg-white px-6 py-5 shadow-sm">
                        <div class="flex-shrink-0">
                            <svg class="size-6 text-stone-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 4v16m8-8H4" />
                            </svg>
                        </div>
                        <div class="min-w-0 flex-1">
                            <p class="text-sm font-medium text-stone-400">More Coming Soon</p>
                            <p class="text-sm text-stone-500">Additional providers will be added</p>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- API Keys -->
    <a name="api-keys"></a>
    <div class="bg-white rounded-xl p-4 md:p-6">
        <div class="border-b border-stone-200 pb-4 mb-4">
            <h2 class="text-lg font-semibold text-stone-900">API Keys</h2>
            <p class="text-sm text-stone-500">Manage your API Keys</p>
        </div>

        <div class="space-y-6">
            <!-- API Keys List -->
            {% if api_keys %}
                <div class="space-y-4">
                    {% for key in api_keys %}
                        <div class="flex items-center justify-between p-4 bg-stone-50 rounded-lg">
                            <div class="space-y-1">
                                <div class="flex items-center gap-2">
                                    <span class="font-medium text-stone-900">{{ key.name }}</span>
                                </div>
                                <p class="text-xs text-stone-400">
                                    Created:
                                    <span
                                        data-timestamp="{{ key.created_at.isoformat() }}"
                                        data-timestamp-format="MMMM D, YYYY h:mm A"
                                    >
                                        {{ key.created_at.strftime('%Y-%m-%d %H:%M:%S') }}
                                    </span>
                                </p>
                                <p class="text-xs text-stone-400">
                                    Last used:
                                    {% if key.last_used %}
                                    <span
                                        data-timestamp="{{ key.last_used.isoformat() }}"
                                        data-timestamp-format="MMMM D, YYYY h:mm A"
                                    >
                                        {{ key.last_used.strftime('%Y-%m-%d %H:%M:%S') }}
                                    </span>
                                    {% else %}
                                    Never
                                    {% endif %}
                                </p>
                            </div>
                            <form action="{{ url_for('api_key.revoke.post', key_id=key.id) }}" method="POST" class="inline" onsubmit="return confirm('Are you sure you want to revoke this API key?')">
                                <button
                                    type="submit"
                                    class="btn-alert btn-sm"
                                >
                                    Revoke
                                </button>
                            </form>
                        </div>
                    {% endfor %}
                </div>
            {% else %}
                <p class="text-stone-500">You haven't created any API keys yet.</p>
            {% endif %}

            <!-- Create a new api key -->
            <div class="border-t border-stone-200 pt-4">
                <h3 class="text-base font-semibold text-stone-900">Create API key</h3>
                <p class="mt-1 text-sm text-stone-500">Create a new API key to access and manage your snippets</p>
                <div class="mt-4">
                     <form action="{{ url_for('api_key.create.post') }}" method="POST" class="flex flex-col">
                         <label for="name" class="block text-sm font-medium text-stone-700">Key Name</label>
                         <div class="flex flex-row items-center justify-between w-full  gap-2">
                             <div class="w-full">
                                 <input type="text" name="name" id="name" required class="form-input">
                             </div>
                             <button type="submit" class="shrink-0 btn-primary btn-sm">
                                 Create API Key
                             </button>
                         </div>
                    </form>

                </div>
            </div>
        </div>
    </div>

    <!-- Delete Account -->
    <div class="bg-white rounded-xl p-4 md:p-6">
        <div class="border-b border-stone-200 pb-4 mb-4">
            <h2 class="text-lg font-semibold text-stone-900">Delete Account</h2>
            <p class="text-sm text-stone-500">Permanently delete your account and all associated data</p>
        </div>

        <div class="flex flex-col space-y-4">
            <p class="text-sm text-stone-600">This action cannot be undone. This will permanently delete your account and all of your data, including snippets.</p>
            <form action="{{ url_for('auth.delete_account') }}" method="POST" class="inline" onsubmit="return confirm('Are you sure you want to delete your account? This action cannot be undone.');">
                <button type="submit" class="btn-alert">
                    Delete Account
                </button>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function toggleDisplayNameEdit() {
    const view = document.getElementById('displayNameView');
    const form = document.getElementById('displayNameForm');
    view.classList.toggle('hidden');
    form.classList.toggle('hidden');
    form.classList.toggle('flex');

    if (form.classList.contains('flex')) {
        form.querySelector('input').focus();
        form.querySelector('input').value = "{{ user.display_name | string }}";
    }
}
</script>
{% endblock %}
